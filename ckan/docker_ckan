FROM phusion/baseimage

RUN apt-get update && apt-get install -y \
	python-dev libpq-dev python-pip git-core sudo \
	python-polib \
	python-virtualenv \
	python-pastescript \
	apache2 libapache2-mod-wsgi libapache2-mod-rpaf nginx \
&& rm -rf /var/lib/apt/lists/*

RUN mkdir /usr/lib/ckan
RUN mkdir /etc/ckan

RUN mkdir -p /usr/lib/ckan/default
RUN chown root /usr/lib/ckan/default
RUN pip install --upgrade pip



WORKDIR /usr/lib/ckan/default/
RUN virtualenv --no-site-packages /usr/lib/ckan/default


RUN . /usr/lib/ckan/default/bin/activate
RUN pip install -e 'git+https://github.com/ckan/ckan.git@ckan-2.5.2#egg=ckan'

RUN pip install -r /usr/lib/ckan/default/src/ckan/requirements.txt
RUN mkdir -p /etc/ckan/default && chown -R `whoami` /etc/ckan/ 
RUN pip uninstall -y paste
RUN pip uninstall -y pastedeploy
RUN pip install --upgrade paste
RUN pip install pastedeploy

RUN pip install setuptools==20.4
RUN pip install pylons==0.9.7
RUN pip install webob==1.0.8
RUN pip install html5lib==0.999

# move to data volume
RUN mkdir /var/lib/ckan
RUN chmod 755 /var/lib/ckan   
RUN chown www-data:www-data /var/lib/ckan

ADD ./config/dev.ini /etc/ckan/default/development.ini
ADD ./config/who.ini /etc/ckan/default/who.ini

WORKDIR /usr/lib/ckan/default/src/ckan

#RUN paster db init -c /etc/ckan/default/development.ini


ADD ./config/apache.wsgi /etc/ckan/default/apache.wsgi 
ADD ./config/ckan.conf /etc/apache2/sites-available/ckan.conf
ADD ./config/apache2.conf /etc/apache2/apache2.conf
ADD ./config/ports.conf  /etc/apache2/ports.conf

#ADD ./nginx.conf  /etc/nginx/sites-available/ckan
ADD ./config/nginx.conf  /etc/nginx/nginx.conf
RUN mkdir /var/cache/nginx

RUN a2ensite ckan
RUN a2dissite 000-default
#RUN rm -f /etc/nginx/sites-enabled/default
#RUN ln -s /etc/nginx/sites-available/ckan /etc/nginx/sites-enabled/ckan


RUN chown www-data:www-data /etc/ckan/default/apache.wsgi

EXPOSE 80 5000


#ADD ./config/contrib/docker/my_init.d /etc/my_init.d
#RUN mkdir /etc/my_init.d
ADD ./config/contrib/docker/svc /etc/service
#CMD ["paster","serve","/etc/ckan/default/development.ini"]

CMD ["/sbin/my_init"]


